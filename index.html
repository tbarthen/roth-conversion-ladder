<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roth Conversion Ladder Optimizer</title>
<script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>
<script src="https://unpkg.com/recharts@2.10.4/umd/Recharts.js"></script>
<style>
/* ============================================================
   GLOBAL STYLES & CSS VARIABLES
   ============================================================ */
:root {
  --bg-primary: #f8f9fa;
  --bg-card: #ffffff;
  --bg-input: #f1f5f9;
  --text-primary: #1a202c;
  --text-secondary: #4a5568;
  --text-muted: #718096;
  --border: #e2e8f0;
  --accent-teal: #0d9488;
  --accent-teal-light: #ccfbf1;
  --accent-teal-dark: #0f766e;
  --accent-green: #059669;
  --accent-green-light: #d1fae5;
  --accent-orange: #ea580c;
  --accent-orange-light: #fff7ed;
  --accent-red: #dc2626;
  --accent-red-light: #fef2f2;
  --accent-blue: #2563eb;
  --accent-blue-light: #eff6ff;
  --accent-purple: #7c3aed;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.5;
}
.app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
h1 { font-size: 1.75rem; font-weight: 700; color: var(--accent-teal-dark); }
h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }
h3 { font-size: 1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }

/* (app-header merged into input card) */

/* Cards */
.card {
  background: var(--bg-card); border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md); padding: 24px; margin-bottom: 16px;
}
/* Form styles */
.form-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px; max-width: 780px;
}
.form-group { display: flex; flex-direction: column; }
.form-group label {
  font-size: 0.8rem; font-weight: 500; color: var(--text-secondary);
  margin-bottom: 4px;
}
.form-group input, .form-group select {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius);
  font-size: 0.9rem; background: var(--bg-input); transition: border-color 0.2s, background 0.2s;
}
.form-group input:focus, .form-group select:focus {
  outline: none; border-color: var(--accent-teal); box-shadow: 0 0 0 3px rgba(13,148,136,0.1);
}
.form-group input[type="number"] { -moz-appearance: textfield; }
.form-group input::-webkit-outer-spin-button,
.form-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.form-group.profile-tinted input,
.form-group.profile-tinted select { background-color: #f0fdf4; }
.form-section-title {
  font-size: 0.85rem; font-weight: 600; color: var(--accent-teal-dark);
  text-transform: uppercase; letter-spacing: 0.05em;
  margin: 20px 0 12px; padding-top: 16px; border-top: 1px solid var(--border);
}
.form-section-title:first-child { margin-top: 0; padding-top: 0; border-top: none; }

/* Input with prefix/suffix */
.input-wrapper {
  position: relative; display: flex; align-items: center;
}
.input-wrapper input {
  width: 100%; padding-left: 24px;
}
.input-wrapper .input-prefix {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 0.85rem; pointer-events: none; z-index: 1;
}
.input-wrapper .input-suffix {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  color: var(--text-muted); font-size: 0.85rem; pointer-events: none; z-index: 1;
}
.input-wrapper.has-suffix input { padding-right: 28px; padding-left: 12px; }
.input-wrapper.has-prefix input { padding-left: 24px; }

/* Collapsible summary line */
.collapsible-summary {
  font-size: 0.8rem; color: var(--text-muted); margin-left: 8px;
  font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* Sticky calculate bar */
.sticky-calc-bar {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 500;
  background: var(--bg-card); border-top: 1px solid var(--border);
  box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
  padding: 12px 20px; text-align: center;
  animation: slideUp 0.2s ease-out;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* Buttons */
.btn {
  padding: 10px 24px; border: none; border-radius: var(--radius);
  font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.btn-primary {
  background: var(--accent-teal); color: white;
}
.btn-primary:hover { background: var(--accent-teal-dark); }
.btn-secondary {
  background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); }
.btn-sm { padding: 6px 14px; font-size: 0.8rem; }

/* Summary cards */
.summary-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px; margin-bottom: 24px;
}
.summary-card {
  padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);
  background: var(--bg-card);
}
.summary-card.positive { border-left: 4px solid var(--accent-green); }
.summary-card.negative { border-left: 4px solid var(--accent-orange); }
.summary-card.neutral { border-left: 4px solid var(--accent-blue); }
.summary-card.warning { border-left: 4px solid var(--accent-red); }
.summary-card .label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
.summary-card .value { font-size: 1.5rem; font-weight: 700; margin-top: 4px; }
.summary-card .sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
.summary-card .value.green { color: var(--accent-green); }
.summary-card .value.orange { color: var(--accent-orange); }
.summary-card .value.blue { color: var(--accent-blue); }
.summary-card .value.red { color: var(--accent-red); }

/* Table styles */
.table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
.data-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.data-table thead { position: sticky; top: 0; z-index: 1; }
.data-table th {
  background: var(--accent-teal-dark); color: white; padding: 10px 8px;
  text-align: right; font-weight: 600; white-space: nowrap;
}
.data-table th:first-child { text-align: left; }
.data-table td { padding: 8px; text-align: right; border-bottom: 1px solid var(--border); }
.data-table td:first-child { text-align: left; }
.data-table tr.conversion-row { background: var(--accent-teal-light); }
.data-table tr.rmd-row { background: var(--accent-orange-light); }
.data-table tr.irmaa-flag { position: relative; }
.data-table tr.irmaa-flag td:last-child { color: var(--accent-red); font-weight: 600; }
.data-table tbody tr:hover { background: #f0fdfa; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }
.tab {
  padding: 8px 16px; border-radius: var(--radius); cursor: pointer;
  font-size: 0.85rem; font-weight: 500; border: 1px solid var(--border);
  background: var(--bg-card); color: var(--text-secondary); transition: all 0.2s;
}
.tab.active { background: var(--accent-teal); color: white; border-color: var(--accent-teal); }
.tab:hover:not(.active) { background: var(--bg-input); }

/* Toggle */
.toggle-group { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
.toggle-switch {
  width: 40px; height: 22px; background: var(--border); border-radius: 11px;
  position: relative; cursor: pointer; transition: background 0.2s;
}
.toggle-switch.active { background: var(--accent-teal); }
.toggle-switch::after {
  content: ''; position: absolute; width: 18px; height: 18px;
  border-radius: 50%; background: white; top: 2px; left: 2px; transition: left 0.2s;
}
.toggle-switch.active::after { left: 20px; }

/* Chart container */
.chart-container { width: 100%; height: 350px; }
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

/* Collapsible */
.collapsible-header {
  display: flex; align-items: center;
  cursor: pointer; padding: 4px 0; user-select: none; gap: 8px;
}
.collapsible-header .arrow { transition: transform 0.2s; font-size: 0.7rem; color: var(--text-muted); flex-shrink: 0; }
.collapsible-header .arrow.open { transform: rotate(90deg); }
.collapsible-header h3 {
  flex-shrink: 0; margin-bottom: 0;
  font-size: 0.85rem; font-weight: 600; color: var(--accent-teal-dark);
  text-transform: uppercase; letter-spacing: 0.05em;
}
.collapsible-content { overflow: hidden; transition: max-height 0.3s; padding-top: 12px; }
.assumptions-list { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.8; }
.assumptions-list li { margin-left: 20px; }

/* IRMAA badge */
.irmaa-badge {
  display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;
  font-weight: 600; background: var(--accent-red-light); color: var(--accent-red);
}

/* Bracket viz */
.bracket-bar { display: flex; height: 24px; border-radius: 4px; overflow: hidden; margin: 2px 0; }
.bracket-segment { display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: white; font-weight: 600; min-width: 1px; }

/* Loading */
.loading { text-align: center; padding: 40px; color: var(--text-muted); }
.spinner {
  width: 40px; height: 40px; border: 3px solid var(--border);
  border-top: 3px solid var(--accent-teal); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Results overlay */
.results-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background-color: #1e293b; z-index: 1000;
  overflow-y: auto; padding: 20px;
  animation: overlayIn 0.25s ease-out;
}
.results-overlay .results-inner {
  max-width: 1100px; margin: 0 auto;
}
.results-overlay .results-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px; flex-wrap: wrap; gap: 12px; color: #e2e8f0;
}
.results-overlay .results-header h1 { color: #f1f5f9; }
.results-overlay .toggle-group { color: #cbd5e1; }
.results-overlay .tab { background: rgba(255,255,255,0.1); color: #cbd5e1; border-color: rgba(255,255,255,0.15); }
.results-overlay .tab.active { background: var(--accent-teal); color: white; border-color: var(--accent-teal); }
.results-overlay .tab:hover:not(.active) { background: rgba(255,255,255,0.18); }
.results-overlay .results-close {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 20px; border-radius: var(--radius); cursor: pointer;
  font-size: 0.85rem; font-weight: 500; border: 1px solid var(--border);
  background: var(--bg-card); color: var(--text-secondary); transition: all 0.2s;
}
.results-overlay .results-close:hover { background: var(--bg-input); }
@keyframes overlayIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 768px) {
  .form-grid { grid-template-columns: 1fr 1fr; max-width: 100%; }
  .summary-grid { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .form-grid { grid-template-columns: 1fr; }
  .collapsible-summary { display: none; }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
/* ============================================================
   ROTH CONVERSION LADDER OPTIMIZER
   A single-page React application for calculating optimal
   Roth conversion strategies to minimize lifetime tax liability.
   ============================================================ */

const { useState, useMemo, useCallback, useRef, useEffect } = React;
const {
  LineChart, Line, AreaChart, Area, BarChart, Bar,
  XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
  ReferenceLine
} = Recharts;

/* ============================================================
   MODULE 1: TAX DATA
   All tax brackets, tables, and thresholds as constants.
   Base year is 2025; future years are inflation-adjusted.
   ============================================================ */
const TAX_DATA = {
  /* Federal income tax brackets [rate, upperBound] */
  brackets: {
    single: [
      [0.10, 11925], [0.12, 48475], [0.22, 103350], [0.24, 197300],
      [0.32, 250525], [0.35, 626350], [0.37, Infinity]
    ],
    marriedFilingJointly: [
      [0.10, 23850], [0.12, 96950], [0.22, 206700], [0.24, 394600],
      [0.32, 501050], [0.35, 751600], [0.37, Infinity]
    ],
    marriedFilingSeparately: [
      [0.10, 11925], [0.12, 48475], [0.22, 103350], [0.24, 197300],
      [0.32, 250525], [0.35, 375800], [0.37, Infinity]
    ]
  },

  /* Standard deduction (2025 base including OBBB 5% boost) */
  standardDeduction: {
    single: 15750,
    marriedFilingJointly: 31500,
    marriedFilingSeparately: 15750,
    additional65PlusSingle: 2000,
    additional65PlusMarried: 1600
  },

  /* Long-term capital gains brackets [rate, upperBound of taxable income] */
  capitalGainsBrackets: {
    single: [[0.00, 48350], [0.15, 533400], [0.20, Infinity]],
    marriedFilingJointly: [[0.00, 96700], [0.15, 600050], [0.20, Infinity]],
    marriedFilingSeparately: [[0.00, 48350], [0.15, 300000], [0.20, Infinity]]
  },

  /* NIIT: 3.8% surtax on lesser of NII or MAGI above threshold */
  niit: {
    rate: 0.038,
    thresholds: { single: 200000, marriedFilingJointly: 250000, marriedFilingSeparately: 125000 }
  },

  /* Social Security taxation thresholds (provisional income) */
  socialSecurity: {
    single: { baseAmount: 25000, additionalAmount: 34000 },
    marriedFilingJointly: { baseAmount: 32000, additionalAmount: 44000 },
    marriedFilingSeparately: { baseAmount: 0, additionalAmount: 0 }
  },

  /* IRMAA thresholds (2025, based on 2023 MAGI) - total monthly premiums per person
     Part B values are total premium (base $185 + surcharge), not surcharge alone.
     Part D values are the surcharge only (added to plan premium).
     Source: SSA / Kiplinger 2025 IRMAA tables */
  irmaa: {
    single: [
      { magi: 106000, partB: 259.00, partD: 13.70 },
      { magi: 133000, partB: 370.00, partD: 35.30 },
      { magi: 167000, partB: 480.90, partD: 57.00 },
      { magi: 200000, partB: 591.90, partD: 78.60 },
      { magi: 500000, partB: 628.90, partD: 85.80 }
    ],
    marriedFilingJointly: [
      { magi: 212000, partB: 259.00, partD: 13.70 },
      { magi: 266000, partB: 370.00, partD: 35.30 },
      { magi: 334000, partB: 480.90, partD: 57.00 },
      { magi: 400000, partB: 591.90, partD: 78.60 },
      { magi: 750000, partB: 628.90, partD: 85.80 }
    ],
    marriedFilingSeparately: [
      { magi: 106000, partB: 591.90, partD: 78.60 },
      { magi: 394000, partB: 628.90, partD: 85.80 }
    ]
  },

  /* Bracket colors for visualization */
  bracketColors: {
    0.10: '#059669', 0.12: '#0d9488', 0.22: '#2563eb',
    0.24: '#7c3aed', 0.32: '#db2777', 0.35: '#ea580c', 0.37: '#dc2626'
  },

  /* Base year for all amounts */
  baseYear: 2025
};

/* State income tax rates (2025 top marginal / flat rates)
   Sources: Tax Foundation, state tax authority websites.
   For progressive states this is the top marginal rate — a simplification
   that works well for retirees with moderate-to-high income.
   Users can override after selection.
   These are fallback values — the app fetches data/rates.json at runtime
   for the latest rates. Edit that file to update. */
let STATE_TAX_RATES = [
  { abbr: "--", name: "-- Select State --", rate: 0 },
  { abbr: "AL", name: "Alabama", rate: 5.0 },
  { abbr: "AK", name: "Alaska", rate: 0.0 },
  { abbr: "AZ", name: "Arizona", rate: 2.5 },
  { abbr: "AR", name: "Arkansas", rate: 3.9 },
  { abbr: "CA", name: "California", rate: 13.3 },
  { abbr: "CO", name: "Colorado", rate: 4.4 },
  { abbr: "CT", name: "Connecticut", rate: 6.99 },
  { abbr: "DE", name: "Delaware", rate: 6.6 },
  { abbr: "DC", name: "District of Columbia", rate: 10.75 },
  { abbr: "FL", name: "Florida", rate: 0.0 },
  { abbr: "GA", name: "Georgia", rate: 5.19 },
  { abbr: "HI", name: "Hawaii", rate: 11.0 },
  { abbr: "ID", name: "Idaho", rate: 5.695 },
  { abbr: "IL", name: "Illinois", rate: 4.95 },
  { abbr: "IN", name: "Indiana", rate: 3.0 },
  { abbr: "IA", name: "Iowa", rate: 3.8 },
  { abbr: "KS", name: "Kansas", rate: 5.58 },
  { abbr: "KY", name: "Kentucky", rate: 4.0 },
  { abbr: "LA", name: "Louisiana", rate: 3.0 },
  { abbr: "ME", name: "Maine", rate: 7.15 },
  { abbr: "MD", name: "Maryland", rate: 6.5 },
  { abbr: "MA", name: "Massachusetts", rate: 9.0 },
  { abbr: "MI", name: "Michigan", rate: 4.25 },
  { abbr: "MN", name: "Minnesota", rate: 9.85 },
  { abbr: "MS", name: "Mississippi", rate: 4.4 },
  { abbr: "MO", name: "Missouri", rate: 4.7 },
  { abbr: "MT", name: "Montana", rate: 5.9 },
  { abbr: "NE", name: "Nebraska", rate: 5.2 },
  { abbr: "NV", name: "Nevada", rate: 0.0 },
  { abbr: "NH", name: "New Hampshire", rate: 0.0 },
  { abbr: "NJ", name: "New Jersey", rate: 10.75 },
  { abbr: "NM", name: "New Mexico", rate: 5.9 },
  { abbr: "NY", name: "New York", rate: 10.9 },
  { abbr: "NC", name: "North Carolina", rate: 4.5 },
  { abbr: "ND", name: "North Dakota", rate: 2.5 },
  { abbr: "OH", name: "Ohio", rate: 3.5 },
  { abbr: "OK", name: "Oklahoma", rate: 4.75 },
  { abbr: "OR", name: "Oregon", rate: 9.9 },
  { abbr: "PA", name: "Pennsylvania", rate: 3.07 },
  { abbr: "RI", name: "Rhode Island", rate: 5.99 },
  { abbr: "SC", name: "South Carolina", rate: 6.0 },
  { abbr: "SD", name: "South Dakota", rate: 0.0 },
  { abbr: "TN", name: "Tennessee", rate: 0.0 },
  { abbr: "TX", name: "Texas", rate: 0.0 },
  { abbr: "UT", name: "Utah", rate: 4.5 },
  { abbr: "VT", name: "Vermont", rate: 8.75 },
  { abbr: "VA", name: "Virginia", rate: 5.75 },
  { abbr: "WA", name: "Washington", rate: 0.0 },
  { abbr: "WV", name: "West Virginia", rate: 4.82 },
  { abbr: "WI", name: "Wisconsin", rate: 7.65 },
  { abbr: "WY", name: "Wyoming", rate: 0.0 }
];
let RATES_LAST_UPDATED = "2025-02-10";
let RATES_TAX_YEAR = 2025;

/* ============================================================
   MODULE 2: RMD CALCULATOR
   IRS Uniform Lifetime Table III and Joint Life Table II.
   RMD starting age: 73 (SECURE 2.0), moving to 75 in 2033.
   ============================================================ */

/* Uniform Lifetime Table III — age to distribution period */
const UNIFORM_LIFETIME_TABLE = {
  72: 27.4, 73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0,
  79: 21.1, 80: 20.2, 81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0,
  86: 15.2, 87: 14.4, 88: 13.7, 89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8,
  93: 10.1, 94: 9.5, 95: 8.9, 96: 8.4, 97: 7.8, 98: 7.3, 99: 6.8,
  100: 6.4, 101: 6.0, 102: 5.6, 103: 5.2, 104: 4.9, 105: 4.6, 106: 4.3,
  107: 4.1, 108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4, 112: 3.3, 113: 3.1,
  114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7, 118: 2.5, 119: 2.3, 120: 2.0
};

/* Joint Life Table II — [ownerAge][beneficiaryAge] = divisor
   Used when sole beneficiary is spouse >10 years younger.
   Subset covering owner ages 70-100 and beneficiary ages 40-89. */
const JOINT_LIFE_TABLE = {};
(function buildJointLifeTable() {
  /* This is a simplified approximation of IRS Joint Life Table II.
     For each (owner, beneficiary) pair, the divisor is approximately:
     the average of their individual life expectancies. */
  for (let owner = 70; owner <= 100; owner++) {
    JOINT_LIFE_TABLE[owner] = {};
    for (let bene = 40; bene <= 100; bene++) {
      /* Approximate joint life expectancy using actuarial approximation */
      const ownerLE = Math.max(1, 86.5 - owner + (owner < 80 ? 2 : 0));
      const beneLE = Math.max(1, 88 - bene + (bene < 70 ? 2 : 0));
      JOINT_LIFE_TABLE[owner][bene] = Math.round((ownerLE + beneLE) * 10) / 10;
    }
  }
  /* Override with actual IRS table values for common combinations */
  const actuals = {
    73: {55: 31.1, 56: 30.5, 57: 30.0, 58: 29.4, 59: 28.9, 60: 28.4, 61: 27.9, 62: 27.4},
    75: {55: 30.0, 56: 29.4, 57: 28.9, 58: 28.3, 59: 27.8, 60: 27.3, 61: 26.8, 62: 26.3, 63: 25.9, 64: 25.4},
    77: {55: 29.1, 57: 27.9, 60: 26.3, 62: 25.4, 65: 24.1, 67: 23.2},
    80: {55: 28.1, 57: 26.9, 60: 25.3, 62: 24.3, 65: 22.9, 67: 22.0, 69: 21.1},
    85: {55: 26.7, 60: 24.0, 65: 21.5, 70: 19.4, 73: 18.2, 75: 17.2},
    90: {55: 25.9, 60: 23.1, 65: 20.4, 70: 18.1, 75: 16.1, 78: 15.0, 80: 14.2}
  };
  for (const [owner, entries] of Object.entries(actuals)) {
    for (const [bene, val] of Object.entries(entries)) {
      if (!JOINT_LIFE_TABLE[+owner]) JOINT_LIFE_TABLE[+owner] = {};
      JOINT_LIFE_TABLE[+owner][+bene] = val;
    }
  }
})();

/**
 * Calculate RMD for a given year.
 * @param {number} age - Owner's age at end of year
 * @param {number} balance - Account balance at end of prior year
 * @param {number} spouseAge - Spouse's age (if applicable)
 * @param {boolean} isMFJ - Whether filing jointly
 * @param {number} year - Calendar year
 * @returns {number} Required Minimum Distribution amount
 */
function calculateRMD(age, balance, spouseAge, isMFJ, year) {
  /* RMD start age: 73 through 2032, 75 starting 2033 (SECURE 2.0) */
  const rmdStartAge = year >= 2033 ? 75 : 73;
  if (age < rmdStartAge) return 0;
  if (balance <= 0) return 0;

  let divisor;

  /* Use Joint Life Table if spouse is sole beneficiary and >10 years younger */
  if (isMFJ && spouseAge && (age - spouseAge > 10)) {
    const ownerKey = Math.min(100, Math.max(70, age));
    const beneKey = Math.min(100, Math.max(40, spouseAge));
    divisor = (JOINT_LIFE_TABLE[ownerKey] && JOINT_LIFE_TABLE[ownerKey][beneKey])
      ? JOINT_LIFE_TABLE[ownerKey][beneKey]
      : UNIFORM_LIFETIME_TABLE[Math.min(120, Math.max(72, age))] || 2.0;
  } else {
    const tableAge = Math.min(120, Math.max(72, age));
    divisor = UNIFORM_LIFETIME_TABLE[tableAge] || 2.0;
  }

  return balance / divisor;
}

/* ============================================================
   MODULE 3: SOCIAL SECURITY TAX CALCULATOR
   Calculates taxable portion of SS benefits based on
   provisional income and filing status.
   ============================================================ */

/**
 * Calculate taxable Social Security amount.
 * Provisional income = AGI + tax-exempt interest + 50% of SS benefits
 * @param {number} ssIncome - Total Social Security income
 * @param {number} otherIncome - AGI excluding SS
 * @param {string} filingStatus - Filing status key
 * @returns {number} Taxable portion of Social Security
 */
function calculateTaxableSS(ssIncome, otherIncome, filingStatus) {
  if (ssIncome <= 0) return 0;
  const thresholds = TAX_DATA.socialSecurity[filingStatus] || TAX_DATA.socialSecurity.single;
  const provisionalIncome = otherIncome + ssIncome * 0.5;

  if (filingStatus === 'marriedFilingSeparately') {
    /* MFS: 85% of SS is taxable if lived with spouse at any point */
    return ssIncome * 0.85;
  }

  if (provisionalIncome <= thresholds.baseAmount) {
    return 0;
  } else if (provisionalIncome <= thresholds.additionalAmount) {
    return Math.min(ssIncome * 0.5, (provisionalIncome - thresholds.baseAmount) * 0.5);
  } else {
    const tier1 = Math.min(
      (thresholds.additionalAmount - thresholds.baseAmount) * 0.5,
      ssIncome * 0.5
    );
    const tier2 = (provisionalIncome - thresholds.additionalAmount) * 0.85;
    return Math.min(ssIncome * 0.85, tier1 + tier2);
  }
}

/* ============================================================
   MODULE 4: FEDERAL TAX CALCULATOR
   Progressive tax computation with inflation-adjusted brackets.
   ============================================================ */

/**
 * Inflate a dollar amount from base year to target year.
 */
function inflateAmount(amount, fromYear, toYear, rate) {
  if (amount === Infinity) return Infinity;
  const years = toYear - fromYear;
  return amount * Math.pow(1 + rate, years);
}

/**
 * Get inflation-adjusted brackets for a given year and filing status.
 */
function getAdjustedBrackets(filingStatus, year, inflationRate) {
  const baseBrackets = TAX_DATA.brackets[filingStatus];
  if (!baseBrackets) return TAX_DATA.brackets.single;
  return baseBrackets.map(([rate, upper]) => [
    rate,
    inflateAmount(upper, TAX_DATA.baseYear, year, inflationRate)
  ]);
}

/**
 * Get inflation-adjusted standard deduction.
 */
function getStandardDeduction(filingStatus, age, spouseAge, year, inflationRate) {
  const sd = TAX_DATA.standardDeduction;
  let base;
  if (filingStatus === 'marriedFilingJointly') base = sd.marriedFilingJointly;
  else if (filingStatus === 'marriedFilingSeparately') base = sd.marriedFilingSeparately;
  else base = sd.single;

  let deduction = inflateAmount(base, TAX_DATA.baseYear, year, inflationRate);

  /* Additional deduction for age 65+ */
  if (age >= 65) {
    if (filingStatus === 'single') {
      deduction += inflateAmount(sd.additional65PlusSingle, TAX_DATA.baseYear, year, inflationRate);
    } else {
      deduction += inflateAmount(sd.additional65PlusMarried, TAX_DATA.baseYear, year, inflationRate);
    }
  }
  if (filingStatus === 'marriedFilingJointly' && spouseAge && spouseAge >= 65) {
    deduction += inflateAmount(sd.additional65PlusMarried, TAX_DATA.baseYear, year, inflationRate);
  }

  return deduction;
}

/**
 * OBBB Senior Bonus Deduction (One Big Beautiful Bill Act, signed July 4 2025).
 * Additional above-the-line deduction for individuals age 65+.
 * - Up to $6,000 per qualifying individual (tax years 2025-2028 only)
 * - MAGI phaseout: begins at $75K (Single/HoH) / $150K (MFJ)
 * - Reduces by $60 for every $1,000 of MAGI above threshold
 * - Fully phased out at $175K (Single) / $250K (MFJ)
 * - MFS filers are NOT eligible
 * Sources: IRS OBBB guidance, TRP Sumner PLLC analysis, Bipartisan Policy Center
 */
function calculateSeniorBonusDeduction(magi, filingStatus, age, spouseAge, year) {
  /* Only applies to tax years 2025 through 2028 */
  if (year < 2025 || year > 2028) return 0;
  /* MFS filers are not eligible */
  if (filingStatus === 'marriedFilingSeparately') return 0;

  const maxPerPerson = 6000;
  const phaseoutStart = filingStatus === 'marriedFilingJointly' ? 150000 : 75000;
  const reductionPer1000 = 60; /* $60 reduction per $1,000 over threshold */

  let qualifyingPersons = 0;
  if (age >= 65) qualifyingPersons++;
  if (filingStatus === 'marriedFilingJointly' && spouseAge && spouseAge >= 65) qualifyingPersons++;

  if (qualifyingPersons === 0) return 0;

  const excessMAGI = Math.max(0, magi - phaseoutStart);
  const reductionPerPerson = Math.min(maxPerPerson, Math.floor(excessMAGI / 1000) * reductionPer1000);
  const perPerson = Math.max(0, maxPerPerson - reductionPerPerson);

  return perPerson * qualifyingPersons;
}

/**
 * Calculate federal income tax using progressive brackets.
 * @param {number} taxableIncome - Income after deductions
 * @param {Array} brackets - Adjusted brackets for the year
 * @returns {number} Federal tax owed
 */
function calculateFederalTax(taxableIncome, brackets) {
  if (taxableIncome <= 0) return 0;
  let tax = 0;
  let prevUpper = 0;
  for (const [rate, upper] of brackets) {
    const taxableInBracket = Math.min(taxableIncome, upper) - prevUpper;
    if (taxableInBracket > 0) {
      tax += taxableInBracket * rate;
    }
    if (taxableIncome <= upper) break;
    prevUpper = upper;
  }
  return tax;
}

/**
 * Determine which bracket a given income falls into.
 */
function getMarginalBracket(taxableIncome, brackets) {
  for (const [rate, upper] of brackets) {
    if (taxableIncome <= upper) return rate;
  }
  return 0.37;
}

/**
 * Get bracket fill details for visualization.
 */
function getBracketFill(taxableIncome, brackets) {
  const fills = [];
  let prevUpper = 0;
  for (const [rate, upper] of brackets) {
    const bracketSize = (upper === Infinity ? taxableIncome * 1.5 : upper) - prevUpper;
    const filled = Math.max(0, Math.min(taxableIncome, upper === Infinity ? taxableIncome : upper) - prevUpper);
    if (bracketSize > 0) {
      fills.push({ rate, filled, capacity: bracketSize, lower: prevUpper, upper: upper === Infinity ? null : upper });
    }
    if (taxableIncome <= upper) break;
    prevUpper = upper;
  }
  return fills;
}

/* ============================================================
   MODULE 5: IRMAA CALCULATOR
   Medicare surcharges based on MAGI from 2 years prior.
   ============================================================ */

/**
 * Calculate annual IRMAA surcharge.
 * @param {number} magi - MAGI for the relevant tax year (2 years prior)
 * @param {string} filingStatus - Filing status key
 * @param {number} year - Year surcharge applies (MAGI is from year-2)
 * @param {number} inflationRate - For threshold adjustment
 * @param {number} numPeople - 1 for single, 2 for MFJ
 * @returns {{ annual: number, tier: string }}
 */
function calculateIRMAA(magi, filingStatus, year, inflationRate, numPeople = 1) {
  const tiers = TAX_DATA.irmaa[filingStatus] || TAX_DATA.irmaa.single;
  let surcharge = 0;
  let tier = 'None';

  for (let i = tiers.length - 1; i >= 0; i--) {
    const adjustedMagi = inflateAmount(tiers[i].magi, TAX_DATA.baseYear, year - 2, inflationRate);
    if (magi > adjustedMagi) {
      surcharge = (tiers[i].partB + tiers[i].partD) * 12 * numPeople;
      tier = `Tier ${i + 1}`;
      break;
    }
  }

  return { annual: surcharge, tier };
}

/* ============================================================
   MODULE 6: PROJECTION ENGINE
   Year-by-year simulation for each scenario.
   ============================================================ */

/**
 * Run a complete year-by-year projection.
 * @param {Object} inputs - All user inputs
 * @param {string} scenario - 'noConversion', 'optimized', or 'custom'
 * @param {number} customConversion - Fixed annual conversion for 'custom' scenario
 * @param {number} targetBracketRate - Target bracket for optimized scenario
 * @param {string} taxPaymentSource - 'taxable' or 'conversion'
 * @returns {Array} Year-by-year projection data
 */
function runProjection(inputs, scenario, customConversion = 0, targetBracketRate = 0.24, taxPaymentSource = 'taxable') {
  /* Coerce all numeric inputs — handles empty-string defaults gracefully */
  const n = (v) => Number(v) || 0;
  const currentAge = n(inputs.currentAge);
  const retirementAge = n(inputs.retirementAge) || currentAge;
  const lifeExpectancy = n(inputs.lifeExpectancy) || 90;
  const filingStatus = inputs.filingStatus;
  const stateTaxRate = n(inputs.stateTaxRate);
  const spouseAge = n(inputs.spouseAge);
  const spouseLifeExpectancy = n(inputs.spouseLifeExpectancy) || 90;
  const traditionalBalance = n(inputs.traditionalBalance);
  const rothBalance = n(inputs.rothBalance);
  const taxableBalance = n(inputs.taxableBalance);
  const hsaBalance = n(inputs.hsaBalance);
  const annualContributions = inputs.annualContributions || { traditional: 0, roth: 0, taxable: 0, hsa: 0 };
  const grossIncome = n(inputs.grossIncome);
  const ssAnnualBenefit = n(inputs.ssAnnualBenefit);
  const ssStartAge = n(inputs.ssStartAge) || 67;
  const spouseSsBenefit = n(inputs.spouseSsBenefit);
  const spouseSsStartAge = n(inputs.spouseSsStartAge) || 67;
  const pensionIncome = n(inputs.pensionIncome);
  const annualSpending = n(inputs.annualSpending);
  const preRetirementGrowth = n(inputs.preRetirementGrowth);
  const rothGrowth = n(inputs.rothGrowth);
  const taxableGrowth = n(inputs.taxableGrowth);
  const inflationRate = n(inputs.inflationRate);
  const bracketInflation = n(inputs.bracketInflation);

  const currentYear = 2025;
  const isRetired = retirementAge <= currentAge;
  const isMFJ = filingStatus === 'marriedFilingJointly';
  const maxAge = Math.max(lifeExpectancy, isMFJ && spouseLifeExpectancy ? spouseLifeExpectancy + (currentAge - (spouseAge || currentAge)) : lifeExpectancy);

  let tradBal = traditionalBalance;
  let rothBal = rothBalance;
  let taxBal = taxableBalance;
  let hsaBal = hsaBalance;
  let cumulativeTax = 0;
  const results = [];
  const magiHistory = []; /* Track MAGI for IRMAA 2-year lookback */

  for (let yearOffset = 0; yearOffset <= maxAge - currentAge; yearOffset++) {
    const year = currentYear + yearOffset;
    const age = currentAge + yearOffset;
    const sAge = spouseAge ? spouseAge + yearOffset : null;
    const working = !isRetired && age < retirementAge;

    /* Growth on balances (beginning of year) */
    const tradGrowthAmt = tradBal * (preRetirementGrowth / 100);
    const rothGrowthAmt = rothBal * (rothGrowth / 100);
    const taxGrowthAmt = taxBal * (taxableGrowth / 100);
    const hsaGrowthAmt = hsaBal * 0.05;

    tradBal += tradGrowthAmt;
    rothBal += rothGrowthAmt;
    taxBal += taxGrowthAmt;
    hsaBal += hsaGrowthAmt;

    /* Pre-retirement contributions */
    if (working && annualContributions) {
      tradBal += annualContributions.traditional || 0;
      rothBal += annualContributions.roth || 0;
      taxBal += annualContributions.taxable || 0;
      hsaBal += annualContributions.hsa || 0;
    }

    /* Income sources */
    const salary = working ? (grossIncome || 0) : 0;
    const pension = (!working || isRetired) ? inflateAmount(pensionIncome || 0, currentYear, year, inflationRate / 100) : 0;
    let ssIncome = 0;
    if (age >= ssStartAge) {
      ssIncome += inflateAmount(ssAnnualBenefit || 0, currentYear, year, inflationRate / 100 * 0.8); // SS COLA ~80% of inflation
    }
    if (isMFJ && sAge && sAge >= (spouseSsStartAge || 67)) {
      ssIncome += inflateAmount(spouseSsBenefit || 0, currentYear, year, inflationRate / 100 * 0.8);
    }

    /* RMD calculation */
    const rmd = calculateRMD(age, tradBal, sAge, isMFJ, year);

    /* Conversion amount */
    let conversionAmount = 0;
    if (scenario === 'optimized' && !working) {
      const brackets = getAdjustedBrackets(filingStatus, year, bracketInflation / 100);
      const stdDed = getStandardDeduction(filingStatus, age, sAge, year, bracketInflation / 100);

      /* Find target bracket ceiling */
      let targetCeiling = 0;
      for (const [rate, upper] of brackets) {
        if (rate <= targetBracketRate) {
          targetCeiling = upper;
        }
      }

      /* Iteratively find optimal conversion accounting for SS taxation feedback
         and the OBBB senior bonus deduction (which phases out with MAGI). */
      let testConv = 0;
      const maxConv = Math.max(0, tradBal - rmd);
      for (let iter = 0; iter < 5; iter++) {
        const testTotalIncome = salary + pension + rmd + testConv;
        const testTaxableSS = calculateTaxableSS(ssIncome, testTotalIncome, filingStatus);
        const testAGI = testTotalIncome + testTaxableSS;
        const testSeniorBonus = calculateSeniorBonusDeduction(testAGI, filingStatus, age, sAge, year);
        const testTaxableIncome = Math.max(0, testAGI - stdDed - testSeniorBonus);
        const room = Math.max(0, targetCeiling - testTaxableIncome + testConv);
        testConv = Math.min(room, maxConv);
      }
      conversionAmount = Math.max(0, testConv);

      /* Don't bother with tiny conversions */
      if (conversionAmount < 1000) conversionAmount = 0;
    } else if (scenario === 'custom' && !working) {
      const inflatedCustom = inflateAmount(customConversion, currentYear, year, inflationRate / 100);
      conversionAmount = Math.min(inflatedCustom, Math.max(0, tradBal - rmd));
    }

    /* Execute conversion */
    tradBal -= (rmd + conversionAmount);
    tradBal = Math.max(0, tradBal);
    rothBal += conversionAmount;

    /* Calculate total income and taxes */
    const totalOrdinaryIncome = salary + pension + rmd + conversionAmount;
    const taxableSS = calculateTaxableSS(ssIncome, totalOrdinaryIncome, filingStatus);
    const agi = totalOrdinaryIncome + taxableSS;
    const stdDed = getStandardDeduction(filingStatus, age, sAge, year, bracketInflation / 100);
    const seniorBonus = calculateSeniorBonusDeduction(agi, filingStatus, age, sAge, year);
    const taxableIncome = Math.max(0, agi - stdDed - seniorBonus);
    const brackets = getAdjustedBrackets(filingStatus, year, bracketInflation / 100);
    const federalTax = calculateFederalTax(taxableIncome, brackets);
    const stateTax = agi * (stateTaxRate / 100);
    const marginalRate = getMarginalBracket(taxableIncome, brackets);

    /* Store MAGI for IRMAA lookback */
    magiHistory.push(agi);

    /* IRMAA (applies to those 65+, based on MAGI from 2 years prior) */
    let irmaa = { annual: 0, tier: 'None' };
    if (age >= 65) {
      /* Use MAGI from 2 years prior if available, otherwise current year */
      const lookbackIndex = magiHistory.length - 3; /* 2 years prior */
      const irmaaMagi = lookbackIndex >= 0 ? magiHistory[lookbackIndex] : agi;
      const irmaaPeople = isMFJ ? 2 : 1;
      irmaa = calculateIRMAA(irmaaMagi, filingStatus, year, bracketInflation / 100, irmaaPeople);
    }

    const totalTax = federalTax + stateTax + irmaa.annual;
    cumulativeTax += totalTax;

    /* Retirement spending and tax payment.
       Income sources (RMD, SS, pension) cover spending first.
       Shortfall drawn from taxable, then Roth, then HSA. */
    if (!working) {
      const inflatedSpending = inflateAmount(annualSpending || 0, currentYear, year, inflationRate / 100);
      /* Available cash from income sources (RMD is distributed as cash, SS & pension too) */
      const cashIncome = rmd + ssIncome + pension;
      /* Total cash needed = spending + taxes (taxes must be paid from somewhere) */
      const totalCashNeed = inflatedSpending + totalTax;
      let shortfall = Math.max(0, totalCashNeed - cashIncome);

      if (taxPaymentSource === 'conversion' && conversionAmount > 0) {
        /* When paying tax from conversion, Roth absorbs the tax cost */
        rothBal -= Math.min(totalTax, rothBal);
        shortfall = Math.max(0, inflatedSpending - cashIncome);
      }

      /* Draw shortfall from taxable first, then Roth, then HSA */
      const fromTaxable = Math.min(shortfall, Math.max(0, taxBal));
      taxBal -= fromTaxable;
      shortfall -= fromTaxable;

      const fromRoth = Math.min(shortfall, Math.max(0, rothBal));
      rothBal -= fromRoth;
      shortfall -= fromRoth;

      const fromHSA = Math.min(shortfall, Math.max(0, hsaBal));
      hsaBal -= fromHSA;
    }

    /* Ensure no negative balances */
    tradBal = Math.max(0, tradBal);
    rothBal = Math.max(0, rothBal);
    taxBal = Math.max(0, taxBal);
    hsaBal = Math.max(0, hsaBal);

    const bracketFill = getBracketFill(taxableIncome, brackets);

    results.push({
      year, age, spouseAge: sAge, tradBal, rothBal, taxBal, hsaBal,
      salary, pension, ssIncome, taxableSS, rmd, conversionAmount,
      agi, seniorBonus, taxableIncome, federalTax, stateTax, irmaaSurcharge: irmaa.annual,
      irmaaTier: irmaa.tier, totalTax, cumulativeTax, marginalRate,
      bracketFill,
      totalEstate: tradBal + rothBal + taxBal + hsaBal,
      isConversionYear: conversionAmount > 0,
      isRMDYear: rmd > 0
    });
  }

  return results;
}

/* ============================================================
   MODULE 7: OPTIMIZER
   Determines optimal conversion amount per year and finds
   the breakeven age.
   ============================================================ */

function findBreakevenAge(scenarioA, scenarioB) {
  for (let i = 0; i < Math.min(scenarioA.length, scenarioB.length); i++) {
    if (scenarioB[i].cumulativeTax < scenarioA[i].cumulativeTax) {
      return scenarioA[i].age;
    }
  }
  return null;
}

/* ============================================================
   MODULE 8: UI COMPONENTS
   React components for input form, results, tables, and charts.
   ============================================================ */

/* ---- Utility formatters ---- */
const fmt = (n) => {
  if (n === undefined || n === null || isNaN(n)) return '$0';
  const abs = Math.abs(Math.round(n));
  const formatted = abs.toLocaleString('en-US');
  return n < 0 ? `-$${formatted}` : `$${formatted}`;
};
const fmtPct = (n) => `${(n * 100).toFixed(0)}%`;
const fmtRate = (n) => `${n.toFixed(1)}%`;

/* ---- Collapsible Section ---- */
function Collapsible({ title, summary, children, defaultOpen = false }) {
  const [open, setOpen] = useState(defaultOpen);
  return React.createElement('div', null,
    React.createElement('div', {
      className: 'collapsible-header',
      onClick: () => setOpen(!open)
    },
      React.createElement('span', { className: `arrow ${open ? 'open' : ''}` }, '\u25B6'),
      React.createElement('h3', null, title),
      !open && summary && React.createElement('span', { className: 'collapsible-summary' }, summary)
    ),
    open && React.createElement('div', { className: 'collapsible-content' }, children)
  );
}

/* ---- Sample Profiles ---- */
const SAMPLE_PROFILES = [
  { value: '', label: 'Start from a sample profile\u2026' },
  { value: 'couple-mid50s', label: 'Couple, mid-50s, moderate savings',
    desc: 'Ages 55 & 53, $500K traditional, recently retired, $70K/yr spending',
    data: {
      currentAge: 55, retirementAge: 55, lifeExpectancy: 90,
      filingStatus: 'marriedFilingJointly',
      spouseAge: 53, spouseLifeExpectancy: 92,
      traditionalBalance: 500000, rothBalance: 50000,
      taxableBalance: 100000, hsaBalance: 15000,
      annualContributions: { traditional: 0, roth: 0, taxable: 0, hsa: 0 },
      grossIncome: 0,
      ssAnnualBenefit: 28000, ssStartAge: 67,
      spouseSsBenefit: 22000, spouseSsStartAge: 67,
      pensionIncome: 0, annualSpending: 70000
    }
  },
  { value: 'high-earner-early', label: 'High earner, early retiree, single',
    desc: 'Age 50, single, $1.2M traditional, planning to retire at 52',
    data: {
      currentAge: 50, retirementAge: 52, lifeExpectancy: 90,
      filingStatus: 'single',
      spouseAge: '', spouseLifeExpectancy: 90,
      traditionalBalance: 1200000, rothBalance: 200000,
      taxableBalance: 400000, hsaBalance: 50000,
      annualContributions: { traditional: 23500, roth: 7000, taxable: 30000, hsa: 4300 },
      grossIncome: 250000,
      ssAnnualBenefit: 36000, ssStartAge: 67,
      spouseSsBenefit: '', spouseSsStartAge: 67,
      pensionIncome: 0, annualSpending: 100000
    }
  },
  { value: 'late-starter-60', label: 'Couple, 60, playing catch-up',
    desc: 'Ages 60 & 58, $250K traditional, still working part-time',
    data: {
      currentAge: 60, retirementAge: 63, lifeExpectancy: 88,
      filingStatus: 'marriedFilingJointly',
      spouseAge: 58, spouseLifeExpectancy: 90,
      traditionalBalance: 250000, rothBalance: 20000,
      taxableBalance: 60000, hsaBalance: 8000,
      annualContributions: { traditional: 15000, roth: 3000, taxable: 5000, hsa: 0 },
      grossIncome: 85000,
      ssAnnualBenefit: 24000, ssStartAge: 67,
      spouseSsBenefit: 18000, spouseSsStartAge: 67,
      pensionIncome: 0, annualSpending: 55000
    }
  },
  { value: 'affluent-near-rmd', label: 'Affluent couple nearing RMDs',
    desc: 'Ages 68 & 65, $2M traditional, already retired, pension income',
    data: {
      currentAge: 68, retirementAge: 62, lifeExpectancy: 92,
      filingStatus: 'marriedFilingJointly',
      spouseAge: 65, spouseLifeExpectancy: 94,
      traditionalBalance: 2000000, rothBalance: 300000,
      taxableBalance: 500000, hsaBalance: 40000,
      annualContributions: { traditional: 0, roth: 0, taxable: 0, hsa: 0 },
      grossIncome: 0,
      ssAnnualBenefit: 38000, ssStartAge: 67,
      spouseSsBenefit: 32000, spouseSsStartAge: 67,
      pensionIncome: 24000, annualSpending: 120000
    }
  }
];

/* ---- Input Form Component ---- */
function InputForm({ inputs, setInputs, onCalculate }) {
  const [showAdvancedGrowth, setShowAdvancedGrowth] = useState(false);
  const [selectedProfile, setSelectedProfile] = useState('');
  const [profileFields, setProfileFields] = useState(new Set());
  const [editedFields, setEditedFields] = useState(new Set());
  const [showStickyCalc, setShowStickyCalc] = useState(false);
  const calcBtnRef = useRef(null);

  /* Intersection observer for sticky calculate button */
  useEffect(() => {
    if (!calcBtnRef.current) return;
    const observer = new IntersectionObserver(
      ([entry]) => setShowStickyCalc(!entry.isIntersecting),
      { threshold: 0 }
    );
    observer.observe(calcBtnRef.current);
    return () => observer.disconnect();
  }, []);

  const update = (field, value) => {
    setEditedFields(prev => new Set(prev).add(field));
    setInputs(prev => {
      const next = { ...prev, [field]: value };
      if (field === 'preRetirementGrowth' && !showAdvancedGrowth) {
        next.rothGrowth = value;
        next.taxableGrowth = value;
      }
      return next;
    });
  };
  const updateNested = (parent, field, value) => {
    setEditedFields(prev => new Set(prev).add(`${parent}.${field}`));
    setInputs(prev => ({
      ...prev,
      [parent]: { ...prev[parent], [field]: value }
    }));
  };

  const applyProfile = (profileValue) => {
    setSelectedProfile(profileValue);
    const profile = SAMPLE_PROFILES.find(p => p.value === profileValue);
    if (!profile || !profile.data) return;
    /* Track which fields this profile sets */
    const fields = new Set();
    Object.keys(profile.data).forEach(k => {
      if (k === 'annualContributions') {
        Object.keys(profile.data[k]).forEach(ck => fields.add(`annualContributions.${ck}`));
      } else {
        fields.add(k);
      }
    });
    setProfileFields(fields);
    setEditedFields(new Set());
    setInputs(prev => ({
      ...prev,
      ...profile.data,
      stateAbbr: prev.stateAbbr,
      stateTaxRate: prev.stateTaxRate,
      preRetirementGrowth: prev.preRetirementGrowth,
      rothGrowth: prev.rothGrowth,
      taxableGrowth: prev.taxableGrowth,
      inflationRate: prev.inflationRate,
      bracketInflation: prev.bracketInflation,
      targetBracket: prev.targetBracket,
      customConversion: prev.customConversion,
      taxPaymentSource: prev.taxPaymentSource
    }));
  };

  const isTinted = (fieldName, nested, parentField) => {
    const key = nested ? `${parentField}.${fieldName}` : fieldName;
    return profileFields.has(key) && !editedFields.has(key);
  };

  const isMFJ = inputs.filingStatus === 'marriedFilingJointly';

  /* Compact currency for summary lines */
  const fmtCompact = (v) => {
    const n = Number(v) || 0;
    if (n === 0) return null;
    if (n >= 1000000) return `$${(n / 1000000).toFixed(1).replace(/\.0$/, '')}M`;
    if (n >= 1000) return `$${(n / 1000).toFixed(0)}K`;
    return `$${n.toLocaleString()}`;
  };

  const isRetired = inputs.retirementAge && inputs.currentAge && Number(inputs.retirementAge) <= Number(inputs.currentAge);

  /* Personal Info summary */
  const filingAbbr = { marriedFilingJointly: 'MFJ', single: 'Single', marriedFilingSeparately: 'MFS' };
  const selectedState = STATE_TAX_RATES.find(s => s.abbr === inputs.stateAbbr);
  const personalSummary = [
    inputs.currentAge ? `Age ${inputs.currentAge}` : null,
    inputs.retirementAge ? `Retire ${inputs.retirementAge}` : null,
    filingAbbr[inputs.filingStatus] || null,
    selectedState && selectedState.abbr !== '--' ? `${selectedState.name} (${selectedState.rate}%)` : null,
    inputs.lifeExpectancy && inputs.lifeExpectancy != 90 ? `LE ${inputs.lifeExpectancy}` : null
  ].filter(Boolean).join(', ') || 'Not set';

  /* Spouse Info summary */
  const spouseSummary = [
    inputs.spouseAge ? `Age ${inputs.spouseAge}` : null,
    inputs.spouseLifeExpectancy ? `LE ${inputs.spouseLifeExpectancy}` : null
  ].filter(Boolean).join(', ') || 'Not set';

  /* Account Balances summary */
  const balParts = [
    fmtCompact(inputs.traditionalBalance) && `Trad: ${fmtCompact(inputs.traditionalBalance)}`,
    fmtCompact(inputs.rothBalance) && `Roth: ${fmtCompact(inputs.rothBalance)}`,
    fmtCompact(inputs.taxableBalance) && `Taxable: ${fmtCompact(inputs.taxableBalance)}`,
    fmtCompact(inputs.hsaBalance) && `HSA: ${fmtCompact(inputs.hsaBalance)}`
  ].filter(Boolean);
  const balanceSummary = balParts.length ? balParts.join(' \u00B7 ') : 'No balances entered';

  /* Annual Contributions summary */
  const contribs = inputs.annualContributions || {};
  const allContribZero = !contribs.traditional && !contribs.roth && !contribs.taxable && !contribs.hsa;
  const contribSummary = allContribZero
    ? (isRetired ? 'None \u2014 already retired' : 'None set')
    : [
        fmtCompact(contribs.traditional) && `Trad: ${fmtCompact(contribs.traditional)}`,
        fmtCompact(contribs.roth) && `Roth: ${fmtCompact(contribs.roth)}`,
        fmtCompact(contribs.taxable) && `Taxable: ${fmtCompact(contribs.taxable)}`,
        fmtCompact(contribs.hsa) && `HSA: ${fmtCompact(contribs.hsa)}`
      ].filter(Boolean).join(' \u00B7 ');

  /* Income summary */
  const incomeParts = [
    inputs.grossIncome > 0 ? `Income: ${fmtCompact(inputs.grossIncome)}` : null,
    inputs.ssAnnualBenefit ? `SS: ${fmtCompact(inputs.ssAnnualBenefit)} at ${inputs.ssStartAge || 67}` : null,
    isMFJ && inputs.spouseSsBenefit ? `Spouse SS: ${fmtCompact(inputs.spouseSsBenefit)} at ${inputs.spouseSsStartAge || 67}` : null,
    inputs.pensionIncome > 0 ? `Pension: ${fmtCompact(inputs.pensionIncome)}` : null,
    inputs.annualSpending ? `Spending: ${fmtCompact(inputs.annualSpending)}` : null
  ].filter(Boolean);
  const incomeSummary = incomeParts.length ? incomeParts.join(' \u00B7 ') : 'None set';

  /* Assumptions & Strategy summary */
  const bracketLabel = { '0.10': '10%', '0.12': '12%', '0.22': '22%', '0.24': '24%', '0.32': '32%', '0.35': '35%' };
  const assumptionsSummary = [
    `Growth: ${inputs.preRetirementGrowth}%`,
    `Inflation: ${inputs.inflationRate}%`,
    `Target: ${bracketLabel[inputs.targetBracket] || '24%'} bracket`,
    inputs.customConversion > 0 ? `Custom: ${fmtCompact(inputs.customConversion)}/yr` : null
  ].filter(Boolean).join(' \u00B7 ');

  const field = (label, fieldName, opts = {}) => {
    const { type = 'number', min, max, step, prefix, suffix, options, nested, parentField, placeholder } = opts;
    const val = nested ? (inputs[parentField] || {})[fieldName] : inputs[fieldName];
    const onChange = nested
      ? (e) => updateNested(parentField, fieldName, type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value)
      : (e) => update(fieldName, type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value);
    const tinted = isTinted(fieldName, nested, parentField);

    if (type === 'select') {
      return React.createElement('div', { className: `form-group${tinted ? ' profile-tinted' : ''}`, key: fieldName },
        React.createElement('label', null, label),
        React.createElement('select', { value: val || '', onChange },
          (options || []).map(o =>
            React.createElement('option', { key: o.value, value: o.value }, o.label)
          )
        )
      );
    }

    const hasPrefix = !!prefix;
    const hasSuffix = suffix === '%';
    const inputEl = React.createElement('input', {
      type: 'number',
      value: val === undefined || val === null ? '' : val,
      placeholder: placeholder || '',
      onChange,
      min, max, step: step || (hasSuffix ? '0.1' : '1')
    });

    if (hasPrefix || hasSuffix) {
      return React.createElement('div', { className: `form-group${tinted ? ' profile-tinted' : ''}`, key: fieldName },
        React.createElement('label', null, label),
        React.createElement('div', { className: `input-wrapper${hasPrefix ? ' has-prefix' : ''}${hasSuffix ? ' has-suffix' : ''}` },
          hasPrefix && React.createElement('span', { className: 'input-prefix' }, '$'),
          inputEl,
          hasSuffix && React.createElement('span', { className: 'input-suffix' }, '%')
        )
      );
    }

    return React.createElement('div', { className: `form-group${tinted ? ' profile-tinted' : ''}`, key: fieldName },
      React.createElement('label', null, label),
      inputEl
    );
  };

  return React.createElement(React.Fragment, null,
    /* ---- Title & Profile Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement('div', { style: { marginBottom: 16 } },
        React.createElement('h1', null, 'Roth Conversion Ladder Optimizer'),
        React.createElement('div', { style: { color: 'var(--text-muted)', fontSize: '0.875rem' } },
          'Compare Roth conversion strategies to minimize lifetime tax liability')
      ),
      React.createElement('div', {
        style: { padding: '12px 16px', background: 'var(--bg-input)', borderRadius: 'var(--radius)', border: '1px solid var(--border)' }
      },
        React.createElement('label', { style: { display: 'block', marginBottom: 6, fontWeight: 600, fontSize: '0.85rem' } },
          'Quick Start \u2014 pick a profile to pre-fill, then adjust to match your situation'),
        React.createElement('select', {
          value: selectedProfile,
          onChange: (e) => applyProfile(e.target.value),
          style: { width: '100%', padding: '8px 12px', borderRadius: 'var(--radius)', border: '1px solid var(--border)', fontSize: '0.9rem' }
        },
          SAMPLE_PROFILES.map(p =>
            React.createElement('option', { key: p.value, value: p.value },
              p.desc ? `${p.label} \u2014 ${p.desc}` : p.label)
          )
        )
      )
    ),

    /* ---- Personal Info Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Personal Info', summary: personalSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('Current Age', 'currentAge', { min: 20, max: 100 }),
          field('Retirement Age', 'retirementAge', { min: 20, max: 100, placeholder: 'same as current if retired' }),
          field('Life Expectancy', 'lifeExpectancy', { min: 50, max: 120 }),
          field('Filing Status', 'filingStatus', {
            type: 'select',
            options: [
              { value: 'marriedFilingJointly', label: 'Married Filing Jointly' },
              { value: 'single', label: 'Single' },
              { value: 'marriedFilingSeparately', label: 'Married Filing Separately' }
            ]
          }),
          React.createElement('div', { className: 'form-group', key: 'stateSelect' },
            React.createElement('label', null, `State (${RATES_TAX_YEAR} rates)`),
            React.createElement('select', {
              value: inputs.stateAbbr || '--',
              onChange: (e) => {
                const selected = STATE_TAX_RATES.find(s => s.abbr === e.target.value);
                setInputs(prev => ({
                  ...prev,
                  stateAbbr: e.target.value,
                  stateTaxRate: selected ? selected.rate : 0
                }));
              },
              style: { maxWidth: '100%' }
            },
              STATE_TAX_RATES.map(s =>
                React.createElement('option', { key: s.abbr, value: s.abbr },
                  s.rate > 0 ? `${s.name} (${s.rate}%)` : s.abbr === '--' ? s.name : `${s.name} (No tax)`)
              )
            ),
            React.createElement('small', {
              style: { display: 'block', marginTop: 4, color: '#888', fontSize: '0.75rem' }
            }, `Rates reflect ${RATES_TAX_YEAR} top marginal rates. New rates typically take effect each January and are updated here manually.`)
          )
        )
      )
    ),

    /* ---- Spouse Info Card (MFJ only) ---- */
    isMFJ && React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Spouse Info', summary: spouseSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('Spouse Current Age', 'spouseAge', { min: 20, max: 100 }),
          field('Spouse Life Expectancy', 'spouseLifeExpectancy', { min: 50, max: 120 })
        )
      )
    ),

    /* ---- Account Balances Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Account Balances', summary: balanceSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('Traditional IRA/401k', 'traditionalBalance', { min: 0, prefix: '$' }),
          field('Roth IRA/401k', 'rothBalance', { min: 0, prefix: '$' }),
          field('Taxable Brokerage', 'taxableBalance', { min: 0, prefix: '$' }),
          field('HSA Balance', 'hsaBalance', { min: 0, prefix: '$' })
        )
      )
    ),

    /* ---- Annual Contributions Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Annual Contributions (Pre-Retirement)', summary: contribSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('To Traditional', 'traditional', { min: 0, prefix: '$', nested: true, parentField: 'annualContributions' }),
          field('To Roth', 'roth', { min: 0, prefix: '$', nested: true, parentField: 'annualContributions' }),
          field('To Taxable', 'taxable', { min: 0, prefix: '$', nested: true, parentField: 'annualContributions' }),
          field('To HSA', 'hsa', { min: 0, prefix: '$', nested: true, parentField: 'annualContributions' })
        )
      )
    ),

    /* ---- Income Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Income', summary: incomeSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('Current Gross Income', 'grossIncome', { min: 0, prefix: '$' }),
          field('Social Security (annual, at FRA)', 'ssAnnualBenefit', { min: 0, prefix: '$', placeholder: 'check ssa.gov/myaccount' }),
          field('SS Start Age', 'ssStartAge', { min: 62, max: 70 }),
          isMFJ && field('Spouse SS Benefit', 'spouseSsBenefit', { min: 0, prefix: '$' }),
          isMFJ && field('Spouse SS Start Age', 'spouseSsStartAge', { min: 62, max: 70 }),
          field('Pension / Other Income', 'pensionIncome', { min: 0, prefix: '$' }),
          field('Annual Retirement Spending', 'annualSpending', { min: 0, prefix: '$', placeholder: '~70-80% of income' })
        )
      )
    ),

    /* ---- Assumptions & Strategy Card ---- */
    React.createElement('div', { className: 'card' },
      React.createElement(Collapsible, { title: 'Assumptions & Strategy', summary: assumptionsSummary, defaultOpen: true },
        React.createElement('div', { className: 'form-grid' },
          field('Investment Growth Rate', 'preRetirementGrowth', { suffix: '%', min: 0, max: 20 }),
          React.createElement('div', { className: 'form-group', key: 'advGrowthToggle' },
            React.createElement('label', { style: { visibility: 'hidden' } }, ' '),
            React.createElement('button', {
              type: 'button',
              onClick: () => {
                if (showAdvancedGrowth) {
                  setInputs(prev => ({ ...prev, rothGrowth: prev.preRetirementGrowth, taxableGrowth: prev.preRetirementGrowth }));
                }
                setShowAdvancedGrowth(!showAdvancedGrowth);
              },
              style: { background: 'none', border: 'none', color: 'var(--accent-teal)', cursor: 'pointer', fontSize: '0.8rem', padding: 0, textDecoration: 'underline' }
            }, showAdvancedGrowth ? 'Use single rate for all accounts' : 'Set different rates per account')
          ),
          showAdvancedGrowth && field('Roth Growth Rate', 'rothGrowth', { suffix: '%', min: 0, max: 20 }),
          showAdvancedGrowth && field('Taxable Growth Rate', 'taxableGrowth', { suffix: '%', min: 0, max: 20 }),
          field('Inflation Rate', 'inflationRate', { suffix: '%', min: 0, max: 10 }),
          field('Bracket Inflation Adj.', 'bracketInflation', { suffix: '%', min: 0, max: 10 })
        ),
        React.createElement('div', { style: { marginTop: 20, paddingTop: 16, borderTop: '1px solid var(--border)' } },
          React.createElement('div', { style: { fontSize: '0.85rem', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 12 } }, 'Conversion Strategy'),
          React.createElement('div', { className: 'form-grid' },
            field('Target Bracket', 'targetBracket', {
              type: 'select',
              options: [
                { value: '0.10', label: '10% Bracket' },
                { value: '0.12', label: '12% Bracket' },
                { value: '0.22', label: '22% Bracket' },
                { value: '0.24', label: '24% Bracket (Default)' },
                { value: '0.32', label: '32% Bracket' },
                { value: '0.35', label: '35% Bracket' }
              ]
            }),
            field('Custom Annual Conversion', 'customConversion', { min: 0, prefix: '$' }),
            field('Tax Payment Source', 'taxPaymentSource', {
              type: 'select',
              options: [
                { value: 'taxable', label: 'Pay from Taxable Account' },
                { value: 'conversion', label: 'Pay from Converted Amount' }
              ]
            })
          )
        )
      )
    ),

    /* ---- Calculate Button (natural position) ---- */
    React.createElement('div', { ref: calcBtnRef, style: { textAlign: 'right', marginTop: 8, marginBottom: 20 } },
      React.createElement('button', {
        className: 'btn btn-primary',
        onClick: onCalculate,
        style: { padding: '14px 56px', fontSize: '1.05rem' }
      }, 'Calculate Optimal Strategy')
    ),

    /* ---- Sticky Calculate Bar ---- */
    showStickyCalc && React.createElement('div', { className: 'sticky-calc-bar' },
      React.createElement('button', {
        className: 'btn btn-primary',
        onClick: onCalculate,
        style: { padding: '12px 48px', fontSize: '1rem' }
      }, 'Calculate Optimal Strategy')
    )
  );
}

/* ---- Summary Dashboard ---- */
function SummaryDashboard({ scenarioA, scenarioB, scenarioC, breakevenAge }) {
  const lastA = scenarioA[scenarioA.length - 1];
  const lastB = scenarioB[scenarioB.length - 1];
  const lastC = scenarioC ? scenarioC[scenarioC.length - 1] : null;

  const taxSavings = lastA.cumulativeTax - lastB.cumulativeTax;
  const estateDiff = lastB.totalEstate - lastA.totalEstate;

  const irmaaYears = scenarioB.filter(y => y.irmaaSurcharge > 0).length;

  return React.createElement('div', null,
    React.createElement('div', { className: 'summary-grid' },
      React.createElement('div', { className: `summary-card ${taxSavings > 0 ? 'positive' : 'negative'}` },
        React.createElement('div', { className: 'label' }, 'Lifetime Tax Savings'),
        React.createElement('div', { className: `value ${taxSavings > 0 ? 'green' : 'red'}` }, fmt(taxSavings)),
        React.createElement('div', { className: 'sub' },
          `No Conversion: ${fmt(lastA.cumulativeTax)} vs Optimized: ${fmt(lastB.cumulativeTax)}`)
      ),
      React.createElement('div', { className: `summary-card ${estateDiff > 0 ? 'positive' : 'neutral'}` },
        React.createElement('div', { className: 'label' }, 'Estate Value Advantage'),
        React.createElement('div', { className: `value ${estateDiff > 0 ? 'green' : 'orange'}` }, fmt(estateDiff)),
        React.createElement('div', { className: 'sub' },
          `No Conversion: ${fmt(lastA.totalEstate)} vs Optimized: ${fmt(lastB.totalEstate)}`)
      ),
      React.createElement('div', { className: 'summary-card neutral' },
        React.createElement('div', { className: 'label' }, 'Breakeven Age'),
        React.createElement('div', { className: 'value blue' }, breakevenAge ? `Age ${breakevenAge}` : 'N/A'),
        React.createElement('div', { className: 'sub' },
          breakevenAge ? 'When Roth strategy pulls ahead' : 'Roth strategy ahead from start or never')
      ),
      irmaaYears > 0 && React.createElement('div', { className: 'summary-card warning' },
        React.createElement('div', { className: 'label' }, 'IRMAA Warning'),
        React.createElement('div', { className: 'value red' }, `${irmaaYears} years`),
        React.createElement('div', { className: 'sub' }, 'Conversion triggers Medicare surcharges')
      ),
      lastC && React.createElement('div', { className: 'summary-card neutral' },
        React.createElement('div', { className: 'label' }, 'Custom Strategy Taxes'),
        React.createElement('div', { className: 'value blue' }, fmt(lastC.cumulativeTax)),
        React.createElement('div', { className: 'sub' }, `Estate: ${fmt(lastC.totalEstate)}`)
      )
    )
  );
}

/* ---- Year-by-Year Table ---- */
function ProjectionTable({ data, label, showReal, inflationRate }) {
  const deflate = (val, yearOffset) => showReal ? val / Math.pow(1 + inflationRate / 100, yearOffset) : val;

  return React.createElement('div', { className: 'table-container' },
    React.createElement('table', { className: 'data-table' },
      React.createElement('thead', null,
        React.createElement('tr', null,
          ['Year', 'Age', 'Sp.Age', 'Traditional', 'Roth', 'Taxable', 'Conversion', 'RMD',
           'Taxable Inc.', 'Fed Tax', 'State Tax', 'IRMAA', 'Total Tax', 'Cum. Tax', 'Bracket']
          .map(h => React.createElement('th', { key: h }, h))
        )
      ),
      React.createElement('tbody', null,
        data.map((row, i) => {
          const rowClass = row.isConversionYear ? 'conversion-row' :
                          row.isRMDYear ? 'rmd-row' : '';
          const irmaaClass = row.irmaaSurcharge > 0 ? ' irmaa-flag' : '';
          return React.createElement('tr', { key: row.year, className: rowClass + irmaaClass },
            React.createElement('td', null, row.year),
            React.createElement('td', null, row.age),
            React.createElement('td', null, row.spouseAge || '-'),
            React.createElement('td', null, fmt(deflate(row.tradBal, i))),
            React.createElement('td', null, fmt(deflate(row.rothBal, i))),
            React.createElement('td', null, fmt(deflate(row.taxBal, i))),
            React.createElement('td', null, row.conversionAmount > 0 ? fmt(deflate(row.conversionAmount, i)) : '-'),
            React.createElement('td', null, row.rmd > 0 ? fmt(deflate(row.rmd, i)) : '-'),
            React.createElement('td', null, fmt(deflate(row.taxableIncome, i))),
            React.createElement('td', null, fmt(deflate(row.federalTax, i))),
            React.createElement('td', null, fmt(deflate(row.stateTax, i))),
            React.createElement('td', null, row.irmaaSurcharge > 0
              ? React.createElement('span', { className: 'irmaa-badge' }, fmt(deflate(row.irmaaSurcharge, i)))
              : '-'),
            React.createElement('td', null, fmt(deflate(row.totalTax, i))),
            React.createElement('td', { style: { fontWeight: 600 } }, fmt(deflate(row.cumulativeTax, i))),
            React.createElement('td', null, fmtPct(row.marginalRate))
          );
        })
      )
    )
  );
}

/* ---- Charts ---- */
function Charts({ scenarioA, scenarioB, scenarioC }) {
  const cumulativeData = scenarioA.map((a, i) => ({
    age: a.age,
    noConversion: Math.round(a.cumulativeTax),
    optimized: Math.round(scenarioB[i]?.cumulativeTax || 0),
    ...(scenarioC ? { custom: Math.round(scenarioC[i]?.cumulativeTax || 0) } : {})
  }));

  const balanceDataB = scenarioB.map(row => ({
    age: row.age,
    Traditional: Math.round(row.tradBal),
    Roth: Math.round(row.rothBal),
    Taxable: Math.round(row.taxBal),
    HSA: Math.round(row.hsaBal)
  }));

  const annualTaxData = scenarioA.map((a, i) => ({
    age: a.age,
    noConversion: Math.round(a.totalTax),
    optimized: Math.round(scenarioB[i]?.totalTax || 0),
    ...(scenarioC ? { custom: Math.round(scenarioC[i]?.totalTax || 0) } : {})
  }));

  const bracketData = scenarioB.map(row => ({
    age: row.age,
    rate10: 0, rate12: 0, rate22: 0, rate24: 0, rate32: 0, rate35: 0, rate37: 0
  }));
  scenarioB.forEach((row, i) => {
    (row.bracketFill || []).forEach(bf => {
      const key = `rate${Math.round(bf.rate * 100)}`;
      if (bracketData[i][key] !== undefined) {
        bracketData[i][key] = Math.round(bf.filled);
      }
    });
  });

  const chartMargin = { top: 5, right: 20, bottom: 5, left: 20 };
  const tooltipFormatter = (value) => fmt(value);

  return React.createElement('div', { className: 'charts-grid' },
    /* Chart 1: Cumulative Tax Comparison */
    React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Cumulative Tax Comparison'),
      React.createElement('div', { className: 'chart-container' },
        React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
          React.createElement(LineChart, { data: cumulativeData, margin: chartMargin },
            React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e2e8f0' }),
            React.createElement(XAxis, { dataKey: 'age', tick: { fontSize: 11 } }),
            React.createElement(YAxis, { tickFormatter: v => `$${(v/1000).toFixed(0)}k`, tick: { fontSize: 11 } }),
            React.createElement(Tooltip, { formatter: tooltipFormatter }),
            React.createElement(Legend, null),
            React.createElement(Line, { type: 'monotone', dataKey: 'noConversion', stroke: '#ea580c', strokeWidth: 2, name: 'No Conversion', dot: false }),
            React.createElement(Line, { type: 'monotone', dataKey: 'optimized', stroke: '#0d9488', strokeWidth: 2, name: 'Optimized', dot: false }),
            scenarioC && React.createElement(Line, { type: 'monotone', dataKey: 'custom', stroke: '#7c3aed', strokeWidth: 2, name: 'Custom', dot: false })
          )
        )
      )
    ),

    /* Chart 2: Account Balances (Optimized Scenario) */
    React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Account Balances (Optimized Strategy)'),
      React.createElement('div', { className: 'chart-container' },
        React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
          React.createElement(AreaChart, { data: balanceDataB, margin: chartMargin },
            React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e2e8f0' }),
            React.createElement(XAxis, { dataKey: 'age', tick: { fontSize: 11 } }),
            React.createElement(YAxis, { tickFormatter: v => `$${(v/1000000).toFixed(1)}M`, tick: { fontSize: 11 } }),
            React.createElement(Tooltip, { formatter: tooltipFormatter }),
            React.createElement(Legend, null),
            React.createElement(Area, { type: 'monotone', dataKey: 'Traditional', stackId: '1', fill: '#ea580c', stroke: '#ea580c', fillOpacity: 0.7 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'Roth', stackId: '1', fill: '#0d9488', stroke: '#0d9488', fillOpacity: 0.7 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'Taxable', stackId: '1', fill: '#2563eb', stroke: '#2563eb', fillOpacity: 0.7 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'HSA', stackId: '1', fill: '#7c3aed', stroke: '#7c3aed', fillOpacity: 0.7 })
          )
        )
      )
    ),

    /* Chart 3: Annual Tax Burden */
    React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Annual Tax Burden Comparison'),
      React.createElement('div', { className: 'chart-container' },
        React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
          React.createElement(BarChart, { data: annualTaxData, margin: chartMargin },
            React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e2e8f0' }),
            React.createElement(XAxis, { dataKey: 'age', tick: { fontSize: 11 } }),
            React.createElement(YAxis, { tickFormatter: v => `$${(v/1000).toFixed(0)}k`, tick: { fontSize: 11 } }),
            React.createElement(Tooltip, { formatter: tooltipFormatter }),
            React.createElement(Legend, null),
            React.createElement(Bar, { dataKey: 'noConversion', fill: '#ea580c', name: 'No Conversion', opacity: 0.8 }),
            React.createElement(Bar, { dataKey: 'optimized', fill: '#0d9488', name: 'Optimized', opacity: 0.8 }),
            scenarioC && React.createElement(Bar, { dataKey: 'custom', fill: '#7c3aed', name: 'Custom', opacity: 0.8 })
          )
        )
      )
    ),

    /* Chart 4: Marginal Bracket by Year (Optimized) */
    React.createElement('div', { className: 'card' },
      React.createElement('h3', null, 'Income by Tax Bracket (Optimized Strategy)'),
      React.createElement('div', { className: 'chart-container' },
        React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
          React.createElement(AreaChart, { data: bracketData, margin: chartMargin },
            React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#e2e8f0' }),
            React.createElement(XAxis, { dataKey: 'age', tick: { fontSize: 11 } }),
            React.createElement(YAxis, { tickFormatter: v => `$${(v/1000).toFixed(0)}k`, tick: { fontSize: 11 } }),
            React.createElement(Tooltip, { formatter: tooltipFormatter }),
            React.createElement(Legend, null),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate10', stackId: '1', fill: '#059669', stroke: '#059669', name: '10%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate12', stackId: '1', fill: '#0d9488', stroke: '#0d9488', name: '12%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate22', stackId: '1', fill: '#2563eb', stroke: '#2563eb', name: '22%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate24', stackId: '1', fill: '#7c3aed', stroke: '#7c3aed', name: '24%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate32', stackId: '1', fill: '#db2777', stroke: '#db2777', name: '32%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate35', stackId: '1', fill: '#ea580c', stroke: '#ea580c', name: '35%', fillOpacity: 0.8 }),
            React.createElement(Area, { type: 'monotone', dataKey: 'rate37', stackId: '1', fill: '#dc2626', stroke: '#dc2626', name: '37%', fillOpacity: 0.8 })
          )
        )
      )
    )
  );
}

/* ---- Key Assumptions Section ---- */
function KeyAssumptions() {
  const today = new Date();
  const updatedDate = new Date(RATES_LAST_UPDATED + 'T00:00:00');
  const monthsStale = (today.getFullYear() - updatedDate.getFullYear()) * 12
    + today.getMonth() - updatedDate.getMonth();
  const isStale = monthsStale >= 12;

  return React.createElement(Collapsible, { title: 'Key Assumptions & Data Sources', defaultOpen: isStale },
    isStale && React.createElement('div', {
      style: {
        background: 'var(--accent-orange-light)', border: '1px solid var(--accent-orange)',
        borderRadius: 'var(--radius)', padding: '12px 16px', marginBottom: 12,
        fontSize: '0.85rem', color: 'var(--accent-orange)'
      }
    },
      React.createElement('strong', null, 'Tax data may be outdated. '),
      `State tax rates were last verified for tax year ${RATES_TAX_YEAR}. `,
      'New rates typically take effect each January. The site owner needs to update and redeploy with the latest rates.'
    ),
    React.createElement('ul', { className: 'assumptions-list' },
      React.createElement('li', null, 'Tax brackets: 2025 federal brackets (IRS Rev. Proc. 2024-40 + OBBB), inflation-adjusted for future years'),
      React.createElement('li', null, 'Standard deduction: 2025 amounts including One Big Beautiful Bill Act 5% increase'),
      React.createElement('li', null, 'Additional standard deduction for age 65+: $2,000 (single), $1,600 (married, per spouse)'),
      React.createElement('li', null, 'OBBB Senior Bonus Deduction: up to $6,000/person age 65+ (2025\u20132028 only), phases out above $75K single / $150K MFJ. MFS not eligible'),
      React.createElement('li', null, 'RMD start age: 73 (SECURE 2.0 Act), moving to 75 starting 2033'),
      React.createElement('li', null, 'RMD divisors: IRS Uniform Lifetime Table III (2022 revision). Joint Life Table II used when spouse is sole beneficiary and 10+ years younger'),
      React.createElement('li', null, 'Social Security taxation: provisional income thresholds ($25K/$34K single, $32K/$44K MFJ) for 0%/50%/85% taxable tiers'),
      React.createElement('li', null, 'IRMAA: 2025 Medicare Part B & D total monthly premiums (based on MAGI from 2 years prior)'),
      React.createElement('li', null, 'Net Investment Income Tax (NIIT): 3.8% on net investment income above $200K (single) / $250K (MFJ) \u2014 NOT inflation-adjusted'),
      React.createElement('li', null, 'Capital gains: 0%/15%/20% brackets for 2025, inflation-adjusted'),
      React.createElement('li', null, 'Social Security COLA: modeled at ~80% of CPI inflation'),
      React.createElement('li', null, 'All brackets and thresholds inflation-adjusted from 2025 base year using the user-specified bracket inflation rate'),
      React.createElement('li', null, 'State tax: 2025 top marginal rates from Tax Foundation; modeled as flat rate on AGI (simplification \u2014 select state, then adjust rate if needed)'),
      React.createElement('li', null, 'Retirement spending withdrawn from: taxable account first, then Roth, then HSA'),
      React.createElement('li', null, 'Does not model: ACA subsidy cliffs, state-specific deductions, AMT, estate/inheritance taxes, or required beginning date nuances')
    )
  );
}

/* ---- Sources & References Section ---- */
function SourcesReferences() {
  const link = (text, url) => React.createElement('a', {
    href: url, target: '_blank', rel: 'noopener noreferrer',
    style: { color: 'var(--accent-teal)', textDecoration: 'underline' }
  }, text);

  return React.createElement(Collapsible, { title: 'Sources & References', defaultOpen: false },
    React.createElement('p', {
      style: { fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: 12 }
    }, 'The tax constants used in this calculator are derived from the following authoritative sources. Click any link to verify.'),
    React.createElement('ul', { className: 'assumptions-list' },
      React.createElement('li', null,
        React.createElement('strong', null, 'Tax brackets & standard deduction: '),
        link('IRS Rev. Proc. 2024-40', 'https://kpmg.com/us/en/taxnewsflash/news/2024/10/tnf-rev-proc-2024-40-inflation-adjustments-for-2025-individual-taxpayers.html'),
        ' \u2014 2025 inflation adjustments for individual taxpayers'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'OBBB standard deduction increase: '),
        link('IRS Rev. Proc. 2025-32', 'https://www.irs.gov/pub/irs-drop/rp-25-32.pdf'),
        ' \u2014 One Big Beautiful Bill Act 5% standard deduction boost'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'OBBB Senior Bonus Deduction: '),
        link('IRS \u2014 OBBB Tax Deductions for Seniors', 'https://www.irs.gov/newsroom/one-big-beautiful-bill-act-tax-deductions-for-working-americans-and-seniors'),
        ' \u2014 Up to $6,000/person age 65+, tax years 2025\u20132028'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'IRMAA thresholds & premiums: '),
        link('Kiplinger \u2014 Medicare Premiums 2025', 'https://www.kiplinger.com/retirement/medicare/medicare-premiums-2025-irmaa-for-parts-b-and-d'),
        ' \u2014 Part B & Part D IRMAA brackets and total monthly premiums'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'Social Security taxation: '),
        link('IRS Publication 915', 'https://www.irs.gov/publications/p915'),
        ' \u2014 Provisional income thresholds for taxable Social Security'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'RMD Uniform Lifetime Table: '),
        link('IRS Publication 590-B', 'https://www.irs.gov/publications/p590b'),
        ' \u2014 Distribution rules and life expectancy tables'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'Capital gains brackets: '),
        link('IRS Rev. Proc. 2024-40', 'https://kpmg.com/us/en/taxnewsflash/news/2024/10/tnf-rev-proc-2024-40-inflation-adjustments-for-2025-individual-taxpayers.html'),
        ' \u2014 0%/15%/20% long-term capital gains thresholds'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'Net Investment Income Tax (NIIT): '),
        link('IRS \u2014 NIIT Q&A', 'https://www.irs.gov/newsroom/questions-and-answers-on-the-net-investment-income-tax'),
        ' \u2014 3.8% surtax thresholds (not inflation-adjusted)'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'State income tax rates: '),
        link('Tax Foundation', 'https://taxfoundation.org/data/all/state/state-income-tax-rates-2025/'),
        ' \u2014 2025 top marginal or flat rates by state'
      ),
      React.createElement('li', null,
        React.createElement('strong', null, 'OBBB tax changes overview: '),
        link('Tax Foundation Analysis', 'https://taxfoundation.org/research/all/federal/one-big-beautiful-bill-act-tax-changes/'),
        ' \u2014 Comprehensive summary of all OBBB tax provisions'
      )
    )
  );
}

/* ---- Main App Component ---- */
function App() {
  const [inputs, setInputs] = useState({
    currentAge: '',
    retirementAge: '',
    lifeExpectancy: 90,
    filingStatus: 'marriedFilingJointly',
    stateAbbr: '--',
    stateTaxRate: 0,
    spouseAge: '',
    spouseLifeExpectancy: 90,
    traditionalBalance: '',
    rothBalance: '',
    taxableBalance: '',
    hsaBalance: 0,
    annualContributions: { traditional: 0, roth: 0, taxable: 0, hsa: 0 },
    grossIncome: 0,
    ssAnnualBenefit: '',
    ssStartAge: 67,
    spouseSsBenefit: '',
    spouseSsStartAge: 67,
    pensionIncome: 0,
    annualSpending: '',
    preRetirementGrowth: 6,
    rothGrowth: 6,
    taxableGrowth: 6,
    inflationRate: 2.5,
    bracketInflation: 2.5,
    targetBracket: '0.24',
    customConversion: 0,
    taxPaymentSource: 'taxable'
  });

  const [results, setResults] = useState(null);
  const [activeTab, setActiveTab] = useState('summary');
  const [showReal, setShowReal] = useState(false);
  const [calculating, setCalculating] = useState(false);
  const [ratesInfo, setRatesInfo] = useState({ year: RATES_TAX_YEAR, updated: RATES_LAST_UPDATED });

  /* Fetch latest rates from data/rates.json at startup */
  useEffect(() => {
    fetch('data/rates.json')
      .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
      .then(data => {
        if (data.states && data.states.length > 0) {
          STATE_TAX_RATES = [
            { abbr: "--", name: "-- Select State --", rate: 0 },
            ...data.states
          ];
          RATES_LAST_UPDATED = data.updated || RATES_LAST_UPDATED;
          RATES_TAX_YEAR = data.year || RATES_TAX_YEAR;
          setRatesInfo({ year: data.year, updated: data.updated });
        }
      })
      .catch(() => { /* Use embedded fallback rates — no action needed */ });
  }, []);

  const onCalculate = useCallback(() => {
    if (!inputs.currentAge || !inputs.annualSpending) {
      alert('Please fill in at least your current age and annual spending before calculating.');
      return;
    }
    setCalculating(true);
    /* Use setTimeout to allow UI to show loading state */
    setTimeout(() => {
      const targetRate = parseFloat(inputs.targetBracket);
      const scenarioA = runProjection(inputs, 'noConversion', 0, targetRate, inputs.taxPaymentSource);
      const scenarioB = runProjection(inputs, 'optimized', 0, targetRate, inputs.taxPaymentSource);
      const scenarioC = inputs.customConversion > 0
        ? runProjection(inputs, 'custom', inputs.customConversion, targetRate, inputs.taxPaymentSource)
        : null;
      const breakevenAge = findBreakevenAge(scenarioA, scenarioB);

      setResults({ scenarioA, scenarioB, scenarioC, breakevenAge });
      setCalculating(false);
      setActiveTab('summary');
    }, 50);
  }, [inputs]);

  return React.createElement('div', { className: 'app-container' },
    React.createElement(InputForm, { inputs, setInputs, onCalculate }),

    calculating && React.createElement('div', { className: 'results-overlay' },
      React.createElement('div', { className: 'results-inner' },
        React.createElement('div', { className: 'card loading' },
          React.createElement('div', { className: 'spinner' }),
          React.createElement('div', null, 'Calculating optimal strategy...')
        )
      )
    ),

    results && !calculating && React.createElement('div', { className: 'results-overlay' },
      React.createElement('div', { className: 'results-inner' },
        React.createElement('div', { className: 'results-header' },
          React.createElement('h1', { style: { fontSize: '1.4rem', margin: 0 } }, 'Results'),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 16, flexWrap: 'wrap' } },
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap' } },
              React.createElement('div', { className: 'toggle-group' },
                React.createElement('span', null, 'Future dollars'),
                React.createElement('div', {
                  className: `toggle-switch ${showReal ? 'active' : ''}`,
                  onClick: () => setShowReal(!showReal)
                }),
                React.createElement('span', null, "Today\u2019s dollars")
              ),
              React.createElement('span', { style: { fontSize: '0.75rem', color: 'var(--text-muted)' } },
                showReal
                  ? "Adjusted for inflation \u2014 today\u2019s purchasing power"
                  : 'Actual future amounts \u2014 not inflation-adjusted')
            ),
            React.createElement('button', {
              className: 'results-close',
              onClick: () => setResults(null)
            }, '\u2190 Edit Inputs')
          )
        ),
        React.createElement('div', { className: 'tabs' },
          [
            { key: 'summary', label: 'Summary' },
            { key: 'charts', label: 'Charts' },
            { key: 'tableA', label: 'No Conversion Table' },
            { key: 'tableB', label: 'Optimized Table' },
            inputs.customConversion > 0 && { key: 'tableC', label: 'Custom Table' },
            { key: 'assumptions', label: 'Assumptions' },
            { key: 'sources', label: 'Sources' }
          ].filter(Boolean).map(t =>
            React.createElement('div', {
              key: t.key,
              className: `tab ${activeTab === t.key ? 'active' : ''}`,
              onClick: () => setActiveTab(t.key)
            }, t.label)
          )
        ),

        activeTab === 'summary' && React.createElement(React.Fragment, null,
          React.createElement(SummaryDashboard, {
            scenarioA: results.scenarioA,
            scenarioB: results.scenarioB,
            scenarioC: results.scenarioC,
            breakevenAge: results.breakevenAge
          }),
          React.createElement(Charts, {
            scenarioA: results.scenarioA,
            scenarioB: results.scenarioB,
            scenarioC: results.scenarioC
          })
        ),

        activeTab === 'charts' && React.createElement(Charts, {
          scenarioA: results.scenarioA,
          scenarioB: results.scenarioB,
          scenarioC: results.scenarioC
        }),

        activeTab === 'tableA' && React.createElement('div', { className: 'card' },
          React.createElement('h2', null, 'Scenario A: No Roth Conversions'),
          React.createElement(ProjectionTable, {
            data: results.scenarioA,
            label: 'No Conversion',
            showReal, inflationRate: inputs.inflationRate
          })
        ),

        activeTab === 'tableB' && React.createElement('div', { className: 'card' },
          React.createElement('h2', null, 'Scenario B: Optimized Roth Conversions'),
          React.createElement(ProjectionTable, {
            data: results.scenarioB,
            label: 'Optimized',
            showReal, inflationRate: inputs.inflationRate
          })
        ),

        activeTab === 'tableC' && results.scenarioC && React.createElement('div', { className: 'card' },
          React.createElement('h2', null, 'Scenario C: Custom Fixed Conversions'),
          React.createElement(ProjectionTable, {
            data: results.scenarioC,
            label: 'Custom',
            showReal, inflationRate: inputs.inflationRate
          })
        ),

        activeTab === 'assumptions' && React.createElement('div', { className: 'card' },
          React.createElement(KeyAssumptions, null)
        ),

        activeTab === 'sources' && React.createElement('div', { className: 'card' },
          React.createElement(SourcesReferences, null)
        )
      )
    )
  );
}

/* Mount the application */
ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
